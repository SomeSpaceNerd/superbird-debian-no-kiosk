# This config is intended to proxy chrome remote debugger so we can access it externally
#   NOTE: when fetching /json, devtoolsFrontendUrl uses Host header to create websocket url parameter
#       you will need to rewrite that parameter with the correct hostname/address before /devtools/, like 192.168.2.21:9222/devtools/

global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

defaults
	log		global
	mode	http
	option	httplog
	option	http-server-close
	option	dontlognull
		timeout connect 5000
		timeout client  50000
		timeout server  50000

frontend remote_debugging
	bind *:9223

	capture request header Origin len 128

	http-request del-header Host

	acl is_options method OPTIONS
	use_backend cors_preflight if is_options

	default_backend chromium_debugging

backend cors_preflight
	# http-after-response set-header Access-Control-Allow-Origin "*" unless { capture.req.hdr(0) -m found }
	http-after-response set-header Access-Control-Allow-Origin %[capture.req.hdr(0)] if { capture.req.hdr(0) -m found }
	http-request return status 200

backend chromium_debugging
	# http-response set-header Access-Control-Allow-Origin "*" unless { capture.req.hdr(0) -m found }
	http-response set-header Access-Control-Allow-Origin %[capture.req.hdr(0)] if { capture.req.hdr(0) -m found }
	server chromium-debug 127.0.0.1:9222 check

